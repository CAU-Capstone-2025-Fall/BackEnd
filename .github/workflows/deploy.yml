- name: SSH into EC2 & deploy
  uses: appleboy/ssh-action@v1.0.3
  with:
    host: ${{ secrets.EC2_HOST }}
    username: ${{ secrets.EC2_USER }}
    key: ${{ secrets.SSH_PRIVATE_KEY }}
    script_stop: true
    script: |
      set -euo pipefail
      cd "${{ secrets.EC2_PATH }}"

      # venv 없으면 생성
      if [ ! -d "${{ secrets.EC2_VENV }}" ]; then
        python3 -m venv "${{ secrets.EC2_VENV }}"
      fi

      # 최신 코드 가져오기
      git fetch --all
      git reset --hard origin/main

      # pip 보장 및 의존성 설치
      "${{ secrets.EC2_VENV }}/bin/python" -m ensurepip --upgrade || true
      "${{ secrets.EC2_VENV }}/bin/python" -m pip install --upgrade pip
      if [ -f requirements.txt ]; then
        "${{ secrets.EC2_VENV }}/bin/pip" install -r requirements.txt
      fi

      # 서비스 재시작
      sudo systemctl restart "${{ secrets.SERVICE_NAME }}"

      # 상태 확인
      systemctl --no-pager --full status "${{ secrets.SERVICE_NAME }}" | head -n 30
