# ============================================================
# ğŸ¶ a_process.py (2ë‹¨ í—¤ë” ëŒ€ì‘)
#   - A1=ì‚¬ìœ¡ê²½í—˜(1,2ë§Œ)
#   - A4=í–¥í›„ ì‚¬ìœ¡ì˜í–¥ (0~1 ì •ê·œí™”)
#   - B3=ìœ ê¸°ì¶©ë™ (ì‘ë‹µ ì—¬ë¶€ë¡œ ë¶„ë¦¬)
# ============================================================

import pandas as pd
from sklearn.preprocessing import MinMaxScaler

# ------------------------------------------------------------
# 1ï¸âƒ£ survey ì›ë³¸ ë¡œë“œ (2ë‹¨ í—¤ë”)
# ------------------------------------------------------------
df = pd.read_excel("data/survey.xlsx", sheet_name="ë§ˆì´í¬ë¡œë°ì´í„°", header=[0, 1])
# ë‘ ë²ˆì§¸ í–‰(ì½”ë“œëª…, A1/A4/B3)ì„ ì‹¤ì œ ì»¬ëŸ¼ëª…ìœ¼ë¡œ ì‚¬ìš©
df.columns = df.columns.get_level_values(1)

print(f"âœ… ì‹¤ì œ ì»¬ëŸ¼ëª… ìƒ˜í”Œ: {df.columns[:10].tolist()}")

# ------------------------------------------------------------
# 2ï¸âƒ£ ì£¼ìš” ì»¬ëŸ¼ ì§€ì •
# ------------------------------------------------------------
col_A1 = "A1"  # ë°˜ë ¤ë™ë¬¼ ì‚¬ìœ¡ê²½í—˜
col_A4 = "A4"  # í–¥í›„ ì‚¬ìœ¡ì˜í–¥
col_B3 = "B3"  # ìœ ê¸°ì¶©ë™

# ------------------------------------------------------------
# 3ï¸âƒ£ ê¸¸ëŸ¬ë³¸ ê²½í—˜ì í•„í„°ë§ (A1=1 ë˜ëŠ” 2)
# ------------------------------------------------------------
A1_vals = pd.to_numeric(df[col_A1], errors="coerce")
mask_owner = A1_vals.isin([1, 2])
df_owner = df[mask_owner].copy()
print(f"[INFO] ì „ì²´ {len(df)}ëª… ì¤‘ ë°˜ë ¤ë™ë¬¼ ì‚¬ìœ¡ ê²½í—˜ì {len(df_owner)}ëª… ìœ ì§€")

# ------------------------------------------------------------
# 4ï¸âƒ£ A4(í–¥í›„ ì‚¬ìœ¡ ì˜í–¥) 0~1 ì •ê·œí™”
# ------------------------------------------------------------
A4_values = pd.to_numeric(df_owner[col_A4], errors="coerce").fillna(0).values.reshape(-1, 1)
scaler = MinMaxScaler()
A4_norm = scaler.fit_transform(A4_values)

# ------------------------------------------------------------
# 5ï¸âƒ£ ê¸°ì¡´ A_processed ë¡œë“œ í›„ ì¸ë±ìŠ¤ ë§ì¶° í•„í„°ë§
# ------------------------------------------------------------
A_all = pd.read_csv("data/A.csv")
A_filtered = A_all.iloc[df_owner.index].copy()

# ------------------------------------------------------------
# 6ï¸âƒ£ ì •ê·œí™”ëœ A4 ì¶”ê°€
# ------------------------------------------------------------
A_filtered["í–¥í›„ ë°˜ë ¤ë™ë¬¼ ì‚¬ìœ¡ì˜í–¥"] = A4_norm

# ------------------------------------------------------------
# 7ï¸âƒ£ ìœ ê¸°ì¶©ë™ ì‘ë‹µ ì—¬ë¶€ë¡œ ë¶„ë¦¬ (B3)
# ------------------------------------------------------------
B3_vals = pd.to_numeric(df_owner[col_B3], errors="coerce")

mask_labeled = B3_vals.notna()
mask_unlabeled = ~mask_labeled

A_labeled = A_filtered[mask_labeled].copy()
A_unlabeled = A_filtered[mask_unlabeled].copy()

print(f"\nğŸ“¦ ë¶„ë¦¬ ê²°ê³¼:")
print(f" - A_labeled: {len(A_labeled)}ëª… (B3 ìœ ê¸°ì¶©ë™ ì‘ë‹µ ìˆìŒ)")
print(f" - A_unlabeled: {len(A_unlabeled)}ëª… (B3 ê³µë€)")

# ------------------------------------------------------------
# 8ï¸âƒ£ ì €ì¥
# ------------------------------------------------------------
A_labeled.to_csv("data/A_labeled.csv", index=False, encoding="utf-8-sig")
A_unlabeled.to_csv("data/A_unlabeled.csv", index=False, encoding="utf-8-sig")

print("\nğŸ¯ ì™„ë£Œ â€” ì €ì¥ë¨:")
print(" - data/A_labeled.csv")
print(" - data/A_unlabeled.csv")
